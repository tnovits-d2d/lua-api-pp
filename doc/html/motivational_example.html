<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Lua-API++: Motivational example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="lpp_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Lua-API++
   &#160;<span id="projectnumber">2015-02-12-3</span>
   </div>
   <div id="projectbrief">Lua-API++ library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('motivational_example.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Motivational example </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>To get a feeling of how the library is used, let's write a simple example program. It will be line interpreter working with standard input stream, with support of fixed-size numeric arrays. We assume that Lua and Lua-API++ are already set up in our project.</p>
<p>First, we start with the interpreter part. The <a class="el" href="classlua_1_1_state.html">State</a> object will create Lua state and interpret strings.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="luapp_8hpp.html">luapp/luapp.hpp</a>&gt;</span></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacestd.html">std</a>;</div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacelua.html">lua</a>;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> interpretLine(<a class="code" href="classlua_1_1_state.html">State</a>&amp; state, <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; line)</div><div class="line">{</div><div class="line">  <span class="keywordflow">try</span> {</div><div class="line">    state.<a class="code" href="classlua_1_1_state.html#aba8b923ec2ff1b88ccb75ab9cf24bf6d">runString</a>(line); <span class="comment">// Attempt to execute string</span></div><div class="line">  } <span class="keywordflow">catch</span>(exception&amp; e) {</div><div class="line">    cerr &lt;&lt; e.what() &lt;&lt; endl;  <span class="comment">// Show error message in case of execution failure</span></div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> interpretStream(<a class="code" href="classlua_1_1_state.html">State</a>&amp; state, istream&amp; in)</div><div class="line">{</div><div class="line">  <span class="keywordtype">string</span> currentLine;</div><div class="line">  <span class="keywordflow">while</span>(!in.eof()) {  <span class="comment">// Read and interpret lines from given stream</span></div><div class="line">    getline(in, currentLine);</div><div class="line">    interpretLine(state, currentLine);</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keyword">const</span> <span class="keywordtype">char</span>* argv[])</div><div class="line">{</div><div class="line">  <a class="code" href="classlua_1_1_state.html">State</a> state;</div><div class="line">  interpretStream(state, cin);</div><div class="line">}</div></div><!-- fragment --><p>With this part done, we can add support of arrays. We will use <code>vector</code> of <code><b>double</b></code> as underlying native type. The simple Lua interface of our arrays will be as follows:</p><ul>
<li>global Lua function <code>createArray</code> will create array objects of given size;</li>
<li>array objects will be accessed with integer indices for reading and writing elements;</li>
<li>wrong index will produce an error;</li>
<li>length operator will return amount of elements in the array.</li>
</ul>
<p>We can salvage some of the functions <code>vector</code> already has, so we need only to register userdata and write a couple of functions. </p><div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacelua.html">lua</a>;</div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div><div class="line"><span class="keyword">using</span> dvec = vector&lt;double&gt;;  <span class="comment">// Nice comfy name for array type</span></div><div class="line"><a class="code" href="luapp_8hpp.html#aa5b908481d9041fe334bfd1674ded658">LUAPP_USERDATA</a>(dvec, <span class="stringliteral">&quot;numeric_array&quot;</span>) <span class="comment">// Register dvec as user data</span></div><div class="line"></div><div class="line">dvec aCreate(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size) <span class="comment">// Function to create array</span></div><div class="line">{</div><div class="line">  <span class="keywordflow">return</span> dvec(size);  <span class="comment">// Created object gets moved into Lua-allocated storage, no expensive reallocations occur.</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> aDestroy(dvec&amp; <span class="keyword">self</span>) <span class="comment">// Destruction function is required because taking destructor address is forbidden</span></div><div class="line">{</div><div class="line">  <span class="keyword">self</span>.~dvec();  <span class="comment">// Explicitly destroy object placed in memory allocated by Lua</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> aWrite(dvec&amp; <span class="keyword">self</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index, <span class="keywordtype">double</span> val)  <span class="comment">// Write a number into array</span></div><div class="line">{</div><div class="line">  <span class="keyword">self</span>.at(index) = val;  <span class="comment">// Use .at() for checked access</span></div><div class="line">}</div></div><!-- fragment --><p>Now we are ready for the final step: setting up the environment. It will require two things: associate metatable with dvec and define array-creating function. The function that does it needs access to Lua state, so it has to be <a class="el" href="namespacelua.html#a8b172d369b96a767aa8c91e02a6211a9">LFunction</a>. </p><div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacelua.html">lua</a>;  <span class="comment">// For automatic link generation</span></div><div class="line"><a class="code" href="classlua_1_1_retval.html">Retval</a> setup(<a class="code" href="classlua_1_1_context.html">Context</a>&amp; c)</div><div class="line">{</div><div class="line">  c.<a class="code" href="classlua_1_1_context.html#a1e702413d170d8cdc00ae9374d7664c7">mt</a>&lt;dvec&gt;() = <span class="comment">// Context&#39;s mt() function gives access to userdata metatable</span></div><div class="line">    <a class="code" href="classlua_1_1_table.html#a196b5d9f1a833e25aa4d80536f279b0a">Table::records</a>(ctx,        <span class="comment">// Assign to MT newly created table filled with key-value pairs</span></div><div class="line">    <span class="stringliteral">&quot;__index&quot;</span>,    <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span>&amp; (dvec::*)(<span class="keywordtype">size_t</span>)<span class="keyword">&gt;</span>(&amp;dvec::at),    <span class="comment">// Explicitly select non-const overload</span></div><div class="line">    <span class="stringliteral">&quot;__newindex&quot;</span>, aWrite,      <span class="comment">// Checked write</span></div><div class="line">    <span class="stringliteral">&quot;__len&quot;</span>,      dvec::size,  <span class="comment">// Salvage vector::size for length operator</span></div><div class="line">    <span class="stringliteral">&quot;__gc&quot;</span>,       aDestroy     <span class="comment">// Salvage vector&#39;s destructor for garbage collection</span></div><div class="line">  );</div><div class="line">  c.<a class="code" href="classlua_1_1_context.html#a7c0195836dcfe548f10ec4db184cde4b">global</a>[<span class="stringliteral">&quot;createArray&quot;</span>] = aCreate;  <span class="comment">// Array creation function is a global value</span></div><div class="line">}</div></div><!-- fragment --><p>This setup function will have to be called from main() by <a class="el" href="classlua_1_1_state.html">State</a> object, so it will need to be transformed into Lua compatible C function with <a class="el" href="namespacelua.html#a0fb38d48b0f92faa1fb0b9cf2553ebd9">mkcf</a> template. Here is the final result: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="luapp_8hpp.html">luapp/luapp.hpp</a>&gt;</span></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacelua.html">lua</a>;</div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacestd.html">std</a>;</div><div class="line"></div><div class="line"><span class="keyword">using</span> dvec = vector&lt;double&gt;;</div><div class="line"><a class="code" href="luapp_8hpp.html#aa5b908481d9041fe334bfd1674ded658">LUAPP_USERDATA</a>(dvec, <span class="stringliteral">&quot;Number array&quot;</span>)</div><div class="line"></div><div class="line">dvec aCreate(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size) { <span class="keywordflow">return</span> dvec(size); }</div><div class="line"><span class="keywordtype">void</span> aDestroy(dvec&amp; <span class="keyword">self</span>) { <span class="keyword">self</span>.~dvec(); }</div><div class="line"><span class="keywordtype">void</span> aWrite(dvec&amp; <span class="keyword">self</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index, <span class="keywordtype">double</span> val) { <span class="keyword">self</span>.at(index) = val; }</div><div class="line"></div><div class="line"><a class="code" href="classlua_1_1_retval.html">Retval</a> setup(<a class="code" href="classlua_1_1_context.html">Context</a>&amp; c)</div><div class="line">{</div><div class="line">  c.<a class="code" href="classlua_1_1_context.html#a1e702413d170d8cdc00ae9374d7664c7">mt</a>&lt;dvec&gt;() = <a class="code" href="classlua_1_1_table.html#a196b5d9f1a833e25aa4d80536f279b0a">Table::records</a>(c,</div><div class="line">    <span class="stringliteral">&quot;__index&quot;</span>,    <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span>&amp; (dvec::*)(<span class="keywordtype">size_t</span>)<span class="keyword">&gt;</span>(&amp;dvec::at),</div><div class="line">    <span class="stringliteral">&quot;__newindex&quot;</span>, aWrite,</div><div class="line">    <span class="stringliteral">&quot;__len&quot;</span>,      dvec::size,</div><div class="line">    <span class="stringliteral">&quot;__gc&quot;</span>,       aDestroy</div><div class="line">  );</div><div class="line">  c.<a class="code" href="classlua_1_1_context.html#a7c0195836dcfe548f10ec4db184cde4b">global</a>[<span class="stringliteral">&quot;createArray&quot;</span>] = aCreate;</div><div class="line">  <span class="keywordflow">return</span> c.<a class="code" href="classlua_1_1_context.html#a3c8e9a2e4b05f93984c482ce00f2781a">ret</a>();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> interpretLine(<a class="code" href="classlua_1_1_state.html">State</a>&amp; state, <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; line)</div><div class="line">{</div><div class="line">  <span class="keywordflow">try</span> {</div><div class="line">    state.<a class="code" href="classlua_1_1_state.html#aba8b923ec2ff1b88ccb75ab9cf24bf6d">runString</a>(line);</div><div class="line">  } <span class="keywordflow">catch</span>(exception&amp; e) {</div><div class="line">    cerr &lt;&lt; e.what() &lt;&lt; endl;</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> interpretStream(<a class="code" href="classlua_1_1_state.html">State</a>&amp; state, istream&amp; in)</div><div class="line">{</div><div class="line">  <span class="keywordtype">string</span> currentLine;</div><div class="line">  <span class="keywordflow">while</span>(!in.eof()){</div><div class="line">    getline(in, currentLine);</div><div class="line">    interpretLine(state, currentLine);</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">  <a class="code" href="classlua_1_1_state.html">State</a> state;</div><div class="line">  state.<a class="code" href="classlua_1_1_state.html#a24c948f536af9c1ee55a4475f8f52538">call</a>(mkcf&lt;setup&gt;);</div><div class="line">  interpretStream(state, cin);</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
